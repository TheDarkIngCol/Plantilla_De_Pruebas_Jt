name: Que ocurrió un día como hoy

on:
  workflow_dispatch:
    inputs:
      month:
        description: "Mes en formato MM"
        required: true
      day:
        description: "Día en formato DD"
        required: true

env:
  LANG: ${{ vars.LANG }}

jobs:
  fetch-api:
    runs-on: ubuntu-latest
    outputs:
      events: ${{ steps.extract.outputs.events }}
    steps:
      - name: Restaurar cache de API
        id: cache-api
        uses: actions/cache@v4
        with:
          path: response.json
          key: onthisday-${{ env.LANG }}-${{ github.event.inputs.month }}-${{ github.event.inputs.day }}

      - name: Llamar API Wikimedia si no hay cache
        if: steps.cache-api.outputs.cache-hit != 'true'
        run: |
          curl -s "https://api.wikimedia.org/feed/v1/wikipedia/${{ env.LANG }}/onthisday/selected/${{ github.event.inputs.month }}/${{ github.event.inputs.day }}" -o response.json

      - name: Extraer eventos
        id: extract
        run: |
          events=$(jq -c '[.selected[] | {title: .pages[0].title, url: .pages[0].content_urls.desktop.page}]' response.json)
          echo "events=$events" >> $GITHUB_OUTPUT

  process-events:
    needs: fetch-api
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        event: ${{ fromJson(needs.fetch-api.outputs.events) }}
    steps:
      - name: Mostrar evento
        run: |
          echo "Título: ${{ matrix.event.title }}"
          echo "URL: ${{ matrix.event.url }}"

      - name: Instalar wkhtmltopdf
        uses: daumann/apt-install-action@v1
        with:
          packages: wkhtmltopdf

      - name: Convertir página web a PDF
        id: convert
        run: |
          safe_title=$(echo "${{ matrix.event.title }}" | tr -cd '[:alnum:]._-')
          filename="${{ github.event.inputs.month }}-${{ github.event.inputs.day }}-${safe_title}.pdf"
          echo "FILENAME=$filename" >> $GITHUB_ENV
          wkhtmltopdf --enable-local-file-access "${{ matrix.event.url }}" "$filename" || echo "Error al convertir PDF"

      - name: Subir artefacto PDF
        uses: actions/upload-artifact@v4
        with:
          name: PDF-${{ env.FILENAME }}
          path: ${{ env.FILENAME }}
          retention-days: 1
